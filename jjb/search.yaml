- project:
    name: search
    project:
        - extra
        - glent
        - highlighter
        - extra-analysis
    jobs:
        - '{name}-{project}-maven-java8-docker'
        - '{name}-{project}-maven-java8-docker-site-publish'

- project:
    name: search-xgboost
    jobs:
        - '{name}-maven-java8-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/java8-xgboost:0.2.1
            maven_args: --file jvm-packages/pom.xml clean verify

- project:
    name: search-mjolnir
    jobs:
        - '{name}-tox-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/tox-pyspark:0.5.1
            build_timeout: 10 # minutes, xgboost takes a while to compile T184754
        # Sadly this does not test the python code with the jvm code, instead
        # using the last release of the jvm code, But it's a good start.
        - '{name}-maven-java8-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/java8-mjolnir:0.2.1
            maven_args: --file jvm/pom.xml clean verify

- project:
    name: java-codehealth
    packages-source: composer
    database: mysql
    jobs:
      - java-codehealth-{name}:
         # Used for analyzing gerrit patch sets.
         name: 'patch'
         branch: '$ZUUL_CHANGE'
         publishers:
           - docker-cleanup

- job-template:
    name: 'java-codehealth-{name}'
    node: Docker
    concurrent: false
    branch: '$ZUUL_BRANCH'
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul

    wrappers:
     - ansicolor
     - timeout:
         timeout: 30
         fail: true
     - timestamps
     # SONAR_API_KEY is in Jenkins credentials store
     # https://integration.wikimedia.org/ci/credentials/
     - credentials-binding:
           - text:
               credential-id: SONAR_API_KEY
               variable: SONAR_API_KEY
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-src-dir
        - docker-run-with-log-cache-src:
            image: 'docker-registry.wikimedia.org/releng/java8-sonar-scanner:0.5.1'
            # Bypass CI fetch/checkout which would discard material from the install stage
            options: '--entrypoint=/run-java --volume "$(pwd)"/src:/workspace/src'
            logdir: '/workspace/log'
    publishers:
      - docker-cleanup
