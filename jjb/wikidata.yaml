- job-template:
    name: '{name}-release-silent'
    project-type: maven
    node: DebianJessie
    concurrent: false

    jdk: 'Debian - OpenJdk 8'
    parameters:
      - string:
          name: 'GIT_URL'
          default: 'ssh://{git-user}@gerrit.wikimedia.org:29418'
      - string:
          name: 'GIT_PROJECT'
          default: '{release-project}'
      - string:
          name: 'GIT_BRANCH'
          default: '{release-branch}'
      - string:
          name: 'GIT_REF'
          default: '{release-branch}'
      - string:
          name: 'GIT_COMMIT'
          default: '{release-branch}'

    scm:
      - git:
          url: '$GIT_URL/$GIT_PROJECT'
          branches:
            - '$GIT_BRANCH'
          local-branch: '$GIT_BRANCH'
          git-config-name: '{git-user}'
          git-config-email: '{git-user-email}'

    wrappers:
      - timeout:
          timeout: 30
          fail: true
      - maven-release:
          release-goals:
            -Dresume=false -Duser.name='{git-user}' -Djdk.net.URLClassPath.disableClassPathURLCheck=true release:prepare release:perform
          dry-run-goals:
            -Dresume=false -Duser.name='{git-user}' -Djdk.net.URLClassPath.disableClassPathURLCheck=true -DdryRun=true release:prepare
          num-successful-builds: 1
      - ssh-agent-credentials:
          users:
            - '{git-user-id}'

    maven:
      goals: clean package
      settings:
        'org.jenkinsci.plugins.configfiles.maven.MavenSettingsConfig.ArchivaCredentialsSettings'
- project:
    name: wikidata-query-gui
    jobs:
      - '{name}-npm-browser-node-6-docker':
          docker_image_var: docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1-s1
      - 'wikidata-query-gui-build'

- project:
    name: wikidata-query-rdf
    git-user: maven-release-user
    git-user-email: maven-release-user@wikimedia.org
    git-user-id: maven-release-user
    release-project: wikidata/query/rdf
    release-branch: master
    jar-update-project: wikidata/query/rdf
    jar-update-branch: master
    jobs:
      - '{name}-maven-java8-docker':
          docker_image_var: docker-registry.wikimedia.org/releng/java8-wikidata-query-rdf:0.3.1
      - '{name}-maven-java8-docker-site-publish':
          docker_image_var: docker-registry.wikimedia.org/releng/java8-wikidata-query-rdf:0.3.1
      - '{name}-release-silent'


- project:
    name: wikidata-query-blazegraph
    jobs:
      - '{name}-maven-java8-docker':
          timeout: 180  # Blazegraph tests are long

- project:
    name: analytics-wmde-toolkit-analyzer
    jobs:
        - '{name}-maven-java8-docker':
            maven_args: --file analyzer/pom.xml test

- job:
    name: 'wikidata-query-gui-build'
    node: DebianJessie
    concurrent: false
    triggers:
     - zuul
    parameters:
        # Zuul parameters for Castor
        - string:
            name: 'ZUUL_BRANCH'
            default: 'master'
        - string:
            name: 'ZUUL_PROJECT'
            default: 'wikidata/query/gui'
        - string:
            name: 'ZUUL_PIPELINE'
            default: 'postmerge'
    scm:
        - git:
            url: https://gerrit.wikimedia.org/r/wikidata/query/gui
            branches:
                - master
            refspec: master
            wipe-workspace: true
            clean:
                after: true
            submodule:
                disable: false
    builders:
        - assert-node-version-6
        - castor-load
        - shell: |
            node --version
            npm --version
            rm -rf node_modules
            npm install
        ## now create and publish a gerrit patch
        ## then publish the artifacts to castor?
        - shell: |
            GIT_AUTHOR_NAME=WDQSGuiBuilder
            GIT_COMMITTER_NAME=WDQSGuiBuilder
            GIT_AUTHOR_EMAIL=wdqs-gui-build@lists.wikimedia.org
            GIT_COMMITTER_EMAIL=wdqs-gui-build@lists.wikimedia.org

            # We do not know Gerrit SSH host fingerprint
            mkdir -p ~/.ssh
            echo -ne 'Host gerrit.wikimedia.org\n  StrictHostKeyChecking no\nUser wdqsguibuilder\n' >> ~/.ssh/config

            npm run deploy
    wrappers:
        - ansicolor
        - timeout:
            timeout: 15 # minutes
        - timestamps
        - ssh-agent-credentials:
            users:
                - 'wdqsguibuilder'
    publishers:
        - archive-log-allow-empty
        - castor-save
