# Publish Doxygen-generated docs to doc.wikimedia.org
# NOTE: Only use this generic job if the desired public directory name
# matches the Git repository name.
- job:
    name: 'doxygen-publish'
    node: Docker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-log-dir
     - docker-src-dir
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/doxygen:0.5.0
         logdir: '/log'
     - doc-publish:
        docsrc: 'src/doc/html'
        docdest: '$DOC_PROJECT/$DOC_SUBPATH'
    publishers:
     - archive-log-allow-empty
     - docker-cleanup

- job: &phpunit-coverage-docker-publish
    name: 'phpunit-coverage-docker-publish'
    node: Docker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-src-dir
     - docker-log-dir
     - docker-ci-src-setup-simple

     # composer install
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/composer-php72:0.2.1-s1
         options: '--workdir /src'
         # prefer-dist to get cacheable content
         args: 'install --no-progress --prefer-dist'
         logdir: /log
     # phpunit coverage
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/php72:0.2.2
         options: '--workdir /src'
         logdir: /log
         args: |
             -d zend_extension=xdebug.so \
             ./vendor/bin/phpunit \
                 --coverage-clover /log/coverage/clover.xml \
                 --coverage-html /log/coverage
     - cover-publish:
        src: 'log/coverage'
        dest: '$DOC_PROJECT'
    publishers:
     - castor-save-workspace-cache
     - docker-cleanup

- project:
    name: eventlogging
    jobs:
        - '{name}-tox-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/tox-eventlogging:0.4.0

- job:
    name: 'oojs-ui-docker-publish'
    node: Docker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-src-dir
     - docker-log-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
         image: 'docker-registry.wikimedia.org/releng/npm-test-oojsui:0.2.2-s2'
         # npm run-script jenkins runs 'npm test' and 'npm run doc'
         args: 'jenkins'
         logdir: '/log'
     # Publish everything in a single job!
     - cover-publish:
        src: 'src/coverage'
        dest: 'oojs-ui'
     - doc-publish:
        docsrc: 'src/demos'
        docdest: 'oojs-ui/$DOC_SUBPATH/demos'
     - doc-publish:
        docsrc: 'src/docs'
        docdest: 'oojs-ui/$DOC_SUBPATH/js'
    publishers:
     - castor-save-workspace-cache
     - docker-cleanup

- job:
    name: 'oojs-ui-doxygen-publish'
    node: Docker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-log-dir
     - docker-src-dir
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/doxygen:0.5.0
         logdir: '/log'
     - doc-publish:
        docsrc: 'src/doc/html'
        docdest: 'oojs-ui/$DOC_SUBPATH/php'
    publishers:
     - archive-log-allow-empty
     - docker-cleanup

- project:
    name: visualeditor
    jobs:
        - '{name}-node10-browser-docker'
        - '{name}-rake-docker'

- project:
    name: unicodejs
    jobs:
        - '{name}-node10-browser-docker'

- project:
    name: fresnel
    jobs:
        - '{name}-node10-browser-docker'

- project:
    name: 'translatewiki'
    jobs:
     - '{name}-rake-docker'

- job-template:
    name: '{name}-typos-docker'
    node: Docker
    triggers:
        - zuul
    builders:
        - docker-run:
            image: docker-registry.wikimedia.org/releng/typos:0.0.2

- job:
    name: 'fail-archived-repositories'
    node: contintLabsSlave
    concurrent: false
    triggers:
     - zuul
    builders:
     - shell: "exit 1"

- project:
    name: wmf-utils
    jobs:
        - '{name}-tox-docker'


- job:
    name: 'audit-resources'
    node: Docker
    concurrent: false
    wrappers:
      - timeout:
          timeout: 180 # 3 hours
          fail: true
      - timestamps
      - ansicolor
    builders:
     - docker-log-dir
     - docker-run-with-log:
         image: docker-registry.wikimedia.org/releng/wikimedia-audit-resources:0.1.2
         logdir: '/log'
    publishers:
     - archive:
         artifacts: 'log/*.log'
         allow-empty: true
     - docker-cleanup
    triggers:
        - timed: "H 21 * * *"

- project:
    name: 'wikimedia-cz-tracker'
    jobs:
        - '{name}-tox-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/tox-mysqld:0.4.0

- project:
    name: 'wikimedia-cz-tools'
    jobs:
        - '{name}-tox-docker'

- project:
    name: 'wikimedia-cz-events'
    jobs:
        - '{name}-tox-docker'

- project:
    name: 'wikimedia-cz-mediawiki-config'
    jobs:
     - '{name}-composer-{phpflavor}-docker':
         phpflavor:
             - php70:
                 image: docker-registry.wikimedia.org/releng/composer-test:0.1.7-s1

- project:
    name: gerrit-plugins
    project:
        - barricade
    jobs:
        - '{name}-{project}-maven-java8-docker'
#        - '{name}-{project}-maven-java8-docker-site-publish'
