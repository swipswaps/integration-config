- project:
    name: '3d2png'
    jobs:
     - '{name}-npm-node-6-docker':
         docker_image_var: docker-registry.wikimedia.org/releng/npm-test-3d2png:0.3.0-s1
     - '{name}-deploy-npm-node-6-docker':
         docker_image_var: docker-registry.wikimedia.org/releng/npm-test-3d2png:0.3.0-s1

- project:
    name: 'graphoid'
    jobs:
     - '{name}-deploy-npm-node-6-docker':
         docker_image_var: docker-registry.wikimedia.org/releng/npm-test-graphoid:0.3.0-s1

- job:
    name: kartotherian-node10-browser-docker
    node: Docker
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-src-dir
     - docker-log-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
        image: 'docker-registry.wikimedia.org/releng/node10-kartotherian:0.1.2-s1'
    publishers:
     - archive-log-allow-empty
     - castor-save-workspace-cache
     - docker-cleanup

- project:
    name: 'mobileapps'
    jobs:
     - '{name}-deploy-npm-node-6-docker'
     - 'mobileapps-periodic-test'

- project:
    name: poolcounter
    jobs:
        - '{name}-tox-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/tox-poolcounter:0.4.0

- project:
    name: recommendation-api
    jobs:
     - '{name}-npm-node-6-docker'
     - '{name}-deploy-npm-node-6-docker'

- project:
    name: 'tilerator'
    jobs:
     - '{name}-deploy-npm-node-6-docker':
         docker_image_var: docker-registry.wikimedia.org/releng/npm-test-maps-service:0.3.0-s1

- job-template:
    name: 'mobileapps-periodic-test'
    node: Docker
    triggers:
     - timed: '@hourly'
    parameters:
     - string:
         name: 'ZUUL_URL'
         default: 'https://gerrit.wikimedia.org/r'
     - string:
         name: 'ZUUL_PROJECT'
         default: 'mediawiki/services/mobileapps'
     - string:
         name: 'ZUUL_REF'
         default: 'master'
     - string:
         name: 'ZUUL_BRANCH'
         default: 'master'
    builders:
     - docker-castor-load
     - docker-src-dir
     - docker-log-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
        image: 'docker-registry.wikimedia.org/releng/node10-test:0.6.0-s1'
        args: 'periodic'
    publishers:
     - irc-wikimedia-infrastructure
     - docker-cleanup

- publisher:
    name: irc-wikimedia-infrastructure
    publishers:
     - ircbot:
        strategy: failure-and-fixed
        notify-start: false
        notify-committers: false
        notify-culprits: false
        notify-upstream: false
        notify-fixers: false
        message-type: summary
        matrix-notifier: only-parent
        channels:
         - name: '#wikimedia-infrastructure'
           notify-only: true

- project:
    name: nodejs-codehealth
    jobs:
      - nodejs-codehealth-{name}:
         name: 'patch'
         branch: '$ZUUL_CHANGE-$ZUUL_PATCHSET'
         # Branch name changes for each revision, e.g. 519448-1, 519448-2
         sonar_args: |
             -Dsonar.projectKey=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.projectName=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.analysis.gerritProjectName="$ZUUL_PROJECT" \
             -Dsonar.organization=wmftest \
             -Dsonar.host.url=https://sonarcloud.io \
             -Dsonar.branch.target="$ZUUL_BRANCH" \
             -Dsonar.branch.name={branch} \
         publishers:
           - docker-cleanup
      - nodejs-codehealth-{name}:
         name: 'master-non-voting'
         branch: '$ZUUL_BRANCH'
         sonar_args: |
             -Dsonar.projectKey=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.projectName=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.organization=wmftest \
             -Dsonar.host.url=https://sonarcloud.io \
         publishers:
             - archive-log-allow-empty
             - castor-save-workspace-cache
             - docker-cleanup

- job-template:
    name: 'nodejs-codehealth-{name}'
    node: Docker
    branch: '$ZUUL_BRANCH'
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul

    wrappers:
     - timeout:
         timeout: 30
         fail: true
     - timestamps
     # SONAR_API_KEY is in Jenkins credentials store
     # https://integration.wikimedia.org/ci/credentials/
     - credentials-binding:
          - text:
              credential-id: SONAR_API_KEY
              variable: SONAR_API_KEY

    builders:
    - docker-log-dir
    - docker-src-dir
    - docker-castor-load
    - docker-run-with-log-and-workspace-cache:
        image: docker-registry.wikimedia.org/releng/node10-test:0.6.0-s1
        options: '--volume "$(pwd)"/src/_NAME":/src'
        logdir: '/workspace/log'
        args: '--if-present coverage'
    - docker-run-with-log-and-workspace-cache:
        image: 'docker-registry.wikimedia.org/releng/java8-sonar-scanner:0.6.2'
        options: '--volume "$(pwd)"/src:/workspace/src'
        logdir: '/workspace/log'
        args: '{sonar_args}'
